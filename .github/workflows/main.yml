<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>厚乳小七模拟器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f5f0f2; overflow: hidden; touch-action: none; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #gameCanvas { width: 700px; height: 525px; background: #fff; display: block; border: 3px solid #ffccd5; border-radius: 12px; box-shadow: 0 5px 15px rgba(255,204,213,0.3); }
        #milkBtn { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 180px; height: 70px; background: linear-gradient(135deg, #ff9f43, #ff6b6b); border: none; border-radius: 35px; color: white; font-size: 30px; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); display: none; cursor: pointer; box-shadow: 0 6px 18px rgba(255,107,107,0.4); transition: all 0.1s ease; z-index: 10; }
        #milkBtn:active { transform: translateX(-50%) scale(0.95); box-shadow: 0 4px 12px rgba(255,107,107,0.3); }
        #hpBar { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); width: 320px; height: 32px; background: rgba(0,0,0,0.15); border-radius: 16px; overflow: hidden; z-index: 10; }
        #hpFill { width: 100%; height: 100%; background: linear-gradient(90deg, #4ecdc4, #45b7aa); transition: width 0.2s ease; }
        #hpText { position: fixed; top: 42px; left: 50%; transform: translateX(-50%); color: white; font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); z-index: 11; }
        #attackTip { position: fixed; top: 12%; left: 50%; transform: translateX(-50%); color: #e74c3c; font-size: 32px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); display: none; z-index: 10; }
        #killTip { position: fixed; top: 40%; left: 50%; transform: translateX(-50%); color: #d63031; font-size: 40px; font-weight: bold; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); display: none; z-index: 20; }
        #countTip { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff4757; font-size: 42px; font-weight: bold; text-shadow: 3px 3px 8px rgba(0,0,0,0.3); display: none; opacity: 0; transition: opacity 0.3s ease; z-index: 30; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="700" height="525"></canvas>
    <div id="hpBar">
        <div id="hpFill"></div>
    </div>
    <div id="hpText">5000/5000</div>
    <button id="milkBtn">后入</button>
    <div id="attackTip">小七正在用力夹住你🥵</div>
    <div id="killTip">你被小七夹断了😱</div>
    <div id="countTip"></div>
    <script>
        const game = {
            canvas: document.getElementById('gameCanvas'),
            ctx: document.getElementById('gameCanvas').getContext('2d'),
            milkBtn: document.getElementById('milkBtn'),
            hpFill: document.getElementById('hpFill'),
            hpText: document.getElementById('hpText'),
            attackTip: document.getElementById('attackTip'),
            killTip: document.getElementById('killTip'),
            countTip: document.getElementById('countTip'),
            config: {
                playerSpeed: 8,
                playerHp: 5000,
                triggerMilkDistance: 130,
                attackValidDistance: 170,
                attackDuration: 5000,
                attackDamage: 78.1391, // 伤害降至78.1391（原250→78.1391）
                xiaoqiMoveSpeed: 2.5, // 速度降至2.5（原4.0→3.0）
                killProbability: 0.10, // 秒杀概率微调至10%
                countTipDuration: 1500,
                doubleTapTime: 300 // 双击判定时间（300ms内两次点击）
            },
            player: {
                x: 150, y: 260, size: 48, hp: 0, targetX: 150, targetY: 260
            },
            xiaoqi: {
                x: 480, y: 260, size: 48, state: 'normal',
                attackTimer: 0, lastAttackTime: 0,
                milkCount: 0,
                moveDirX: (Math.random() - 0.5) * 2.0
            },
            touch: {
                isTouching: false, touchX: 0, touchY: 0,
                lastTapTime: 0, // 记录上一次点击时间（双击判定用）
                lastTapX: 0, lastTapY: 0 // 记录上一次点击位置
            },
            scaleRatio: 1,
            isGameOver: false
        };
        function initGame() {
            game.player.hp = game.config.playerHp;
            updateHpDisplay();
            
            const canvasRect = game.canvas.getBoundingClientRect();
            game.scaleRatio = canvasRect.width / game.canvas.width;
            
            // 玩家触摸控制+双击小七判定
            game.canvas.addEventListener('touchstart', (e) => {
                if (game.isGameOver) return;
                const touch = e.touches[0];
                const rect = game.canvas.getBoundingClientRect();
                // 转换触摸坐标为游戏画布坐标
                const tapX = (touch.clientX - rect.left) / game.scaleRatio;
                const tapY = (touch.clientY - rect.top) / game.scaleRatio;
                const currentTime = Date.now();
                // 双击判定：300ms内、点击位置在小七范围内
                if (currentTime - game.touch.lastTapTime <= game.config.doubleTapTime) {
                    const distanceToXiaoqi = getDistance(tapX, tapY, game.xiaoqi.x, game.xiaoqi.y);
                    if (distanceToXiaoqi <= game.xiaoqi.size) {
                        // 双击小七触发后入效果（同按钮逻辑）
                        useMilk();
                        game.touch.lastTapTime = 0; // 重置双击状态
                        return;
                    }
                }
                // 非双击：更新玩家目标位置+记录点击信息
                game.touch.touchX = tapX;
                game.touch.touchY = tapY;
                game.touch.isTouching = true;
                game.player.targetX = tapX;
                game.player.targetY = tapY;
                // 记录本次点击时间和位置
                game.touch.lastTapTime = currentTime;
                game.touch.lastTapX = tapX;
                game.touch.lastTapY = tapY;
            });
            game.canvas.addEventListener('touchmove', (e) => {
                if (game.isGameOver || !game.touch.isTouching) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = game.canvas.getBoundingClientRect();
                game.player.targetX = (touch.clientX - rect.left) / game.scaleRatio;
                game.player.targetY = (touch.clientY - rect.top) / game.scaleRatio;
            });
            game.canvas.addEventListener('touchend', () => {
                game.touch.isTouching = false;
            });
            // 后入按钮点击逻辑（保留）
            game.milkBtn.addEventListener('click', useMilk);
            
            requestAnimationFrame(gameLoop);
        }
        // 后入核心逻辑（按钮+双击小七共用）
        function useMilk() {
            if (game.xiaoqi.state === 'attack' || game.isGameOver) return;
            game.xiaoqi.state = 'attack';
            game.xiaoqi.attackTimer = game.config.attackDuration;
      
